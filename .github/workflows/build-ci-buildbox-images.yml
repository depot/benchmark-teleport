name: Build CI Buildbox Images
on:
  push: {}
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write

jobs:
  buildbox-gha:
    name: Build Ubuntu Buildbox on GHA
    runs-on: ubuntu-22.04-32
    defaults:
      run:
        working-directory: upstream

    steps:
      - name: Checkout Teleport
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@6524bf65af31da8d45b59e8c27de4bd072b392f5 # v3.8.0
        with:
          driver: docker

      # We need to keep env vars in sync, so, we can't use standard build actions
      - name: Build and push buildbox image
        run: cd build.assets && make buildbox

  buildbox-depot:
    name: Build Ubuntu Buildbox on Depot
    runs-on: depot-ubuntu-22.04-32
    defaults:
      run:
        working-directory: upstream

    steps:
      - name: Checkout Teleport
        uses: actions/checkout@v4
        with:
          submodules: true

      - uses: depot/setup-action@v1

      # We need to keep env vars in sync, so, we can't use standard build actions
      - name: Build and push buildbox image
        run: cd build.assets && make buildbox

name: Build CI Buildbox Images
on:
  push: {}
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write

jobs:
  buildbox-gha:
    name: Build Ubuntu Buildbox on GHA
    runs-on: ubuntu-22.04-32
    defaults:
      run:
        working-directory: upstream

    steps:
      - name: Checkout Teleport
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@6524bf65af31da8d45b59e8c27de4bd072b392f5 # v3.8.0
        with:
          driver: docker

      # We need to keep env vars in sync, so, we can't use standard build actions
      - name: Build buildbox image
        run: cd build.assets && make buildbox

  buildbox-depot:
    name: Build Ubuntu Buildbox on Depot
    runs-on: depot-ubuntu-22.04-32
    defaults:
      run:
        working-directory: upstream

    steps:
      - name: Checkout Teleport
        uses: actions/checkout@v4
        with:
          submodules: true

      - uses: depot/setup-action@v1

      # We need to keep env vars in sync, so, we can't use standard build actions
      - name: Build buildbox image
        # Changing the docker buildx build command from cd build.assets && make buildbox to depot build
        run: |
          depot build \
          --build-arg UID=$$(id -u) \
          --build-arg GID=$$(id -g) \
          --build-arg GOLANG_VERSION=go1.24.0 \
          --build-arg GOLANGCI_LINT_VERSION=v1.64.5 \
          --build-arg RUST_VERSION=1.81.0 \
          --build-arg WASM_PACK_VERSION=0.12.1 \
          --build-arg NODE_VERSION=20.18.0 \
          --build-arg LIBBPF_VERSION=1.2.2 \
          --build-arg BUF_VERSION=v1.48.0 \
          --build-arg GOGO_PROTO_TAG=v1.3.2 \
          --build-arg NODE_GRPC_TOOLS_VERSION=1.12.4 \
          --build-arg NODE_PROTOC_TS_VERSION=5.0.1 \
          --build-arg PROTOC_VERSION=26.1 \
          --cache-to type=inline \
          --cache-from ghcr.io/gravitational/teleport-buildbox/teleport18 \
          --load
          --tag ghcr.io/gravitational/teleport-buildbox/teleport18 .
